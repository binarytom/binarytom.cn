understand-lsm-tree.md

# LSM-TREE

LSM-TREE(Log-structured Merge Tree)是一种利用磁盘特性，显著提升写吞吐量的存储查询结构。主要是利用了磁盘在顺序访问的效率远高于随机访问的效率，通过设计的分层存储的方式和WAL（Write-ahead logging），达到增大写吞吐量的目的。对于随机的索引，也能有很高的吞吐量。

## 和B+树的对比

首先B+树本身也很好的利用了磁盘的特性做了优化，减少磁盘IO、底层用链表可以让范围查询可以顺序访问磁盘。主要有下列一些优点：

- 高度低，block内索引密度高，可以减少io次数
- 是平衡树，且数据都位于叶子节点，查询稳定
- 叶子节点形成有序链表，范围查询时可以顺序访问磁盘，提高读取效率

不过B+树在提升查询速度和稳定性的同时，牺牲了写入时的吞吐量作为代价。在使用innodb的mysql时，会建议使用自增id作为主键，就是为了减少维护索引的B+树并且保证叶子有序的成本。如果使用随机的index，那么大量的insert操作，就会带来磁盘大量的随机写操作。即离散的index会导致写性能下降。

## LSM树的介绍

和B+树不同的是，在这个写入和查询的取舍中，LSM树选择了偏向写。将写入数据分层，最上层放在内存中的MemTable，所有的写入均为内存操作。同时为了保证已经写入数据的可靠性，将所有的写入记录在磁盘的WAL中，于是对任意key的写入操作，变成了对磁盘的顺序写入以及内存的表维护，并在MemTable到达足够大小的时候刷入磁盘。整个LSM由下面几个概念构成。

### MemTable

MemTable是保存在内存中的数据结构，保存了最新的数据。会按照key的顺序有序组织数据。对于这块有序组织如何实现，实现者可以根据自身的需求来自行选择。

### Immutable MemTable

当MemTable达到一定大小时，需要写入磁盘。这时为了不阻塞数据写入的过程，会先将MemTable转化为Immut MemTable,并新开一个MemTable用来写入新数据。然后将Immut MemTable刷入磁盘变为SSTable。

### SSTable
